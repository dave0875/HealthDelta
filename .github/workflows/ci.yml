name: CI

on:
  push:
  pull_request:

jobs:
  linux-tests:
    name: Linux (non-iOS tests)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install duckdb
          python3 -c 'import duckdb; print("duckdb_version=" + duckdb.__version__)'

      - name: Run non-iOS tests (headless)
        run: |
          set -euo pipefail
          mkdir -p artifacts/linux
          python3 --version | tee artifacts/linux/python_version.txt

          set +e
          python3 -m unittest discover -s tests -p 'test_*.py' -v | tee artifacts/linux/unittest.log
          unittest_exit="${PIPESTATUS[0]}"
          set -e

          echo "UNITTEST_EXIT=$unittest_exit" >> "$GITHUB_ENV"

      - name: Upload Linux unittest artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-unittest
          path: |
            artifacts/linux/python_version.txt
            artifacts/linux/unittest.log
          if-no-files-found: error

      - name: Fail if unittest failed
        if: always()
        run: |
          set -euo pipefail
          if [ "${UNITTEST_EXIT:-0}" != "0" ]; then
            echo "unittest failed with exit code ${UNITTEST_EXIT}"
            exit "${UNITTEST_EXIT}"
          fi

  ios-xcode-tests:
    name: macOS (Xcode simulator tests)
    runs-on: [self-hosted, macOS, arm64, xcode]
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Xcode version
        run: |
          set -euo pipefail
          xcodebuild -version

      - name: List available simulators
        run: |
          set -euo pipefail
          xcrun simctl list devices available

      - name: Ensure xcodegen is available
        run: |
          set -euo pipefail
          if command -v xcodegen >/dev/null 2>&1; then
            xcodegen --version
            exit 0
          fi

          if command -v brew >/dev/null 2>&1; then
            brew install xcodegen
            xcodegen --version
            exit 0
          fi

          echo "ERROR: xcodegen is required but was not found, and Homebrew is not available."
          echo "See docs/runbook_xcode.md for runner setup."
          exit 1

      - name: Generate Xcode project (xcodegen)
        run: |
          set -euo pipefail
          (cd ios/HealthDelta && xcodegen generate)

      - name: Run xcodebuild tests (iPhone Simulator)
        run: |
          set -euo pipefail
          mkdir -p artifacts

          if [ -z "${DESTINATION:-}" ]; then
            DESTINATION="$(python3 -c 'import json,subprocess; data=json.loads(subprocess.check_output(["xcrun","simctl","list","devices","available","-j"], text=True)); devices=[d["udid"] for runtime in (data.get("devices") or {}).values() for d in runtime if d.get("isAvailable") and "iPhone" in (d.get("name") or "") and d.get("udid")]; assert devices, "No available iPhone simulators found."; print(f"platform=iOS Simulator,id={devices[0]}")')"
          fi
          RESULT_BUNDLE_PATH="${RESULT_BUNDLE_PATH:-artifacts/HealthDelta.xcresult}"

          set +e
          xcodebuild test \
            -project ios/HealthDelta/HealthDelta.xcodeproj \
            -scheme HealthDelta \
            -destination "$DESTINATION" \
            -resultBundlePath "$RESULT_BUNDLE_PATH" \
            | tee artifacts/xcodebuild.log
          xcodebuild_exit="${PIPESTATUS[0]}"
          set -e

          echo "XCODEBUILD_EXIT=$xcodebuild_exit" >> "$GITHUB_ENV"

      - name: Export JUnit (if xcpretty available)
        if: always()
        run: |
          set -euo pipefail
          if [ -f artifacts/xcodebuild.log ] && command -v xcpretty >/dev/null 2>&1; then
            cat artifacts/xcodebuild.log | xcpretty --report junit --output artifacts/junit.xml
          else
            echo "xcpretty not found; skipping JUnit export (see docs/runbook_xcode.md)."
          fi

      - name: Upload xcresult + logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-xcresult
          path: |
            artifacts/HealthDelta.xcresult
            artifacts/xcodebuild.log
            artifacts/junit.xml
          if-no-files-found: error

      - name: Fail if xcodebuild failed
        if: always()
        run: |
          set -euo pipefail
          if [ "${XCODEBUILD_EXIT:-0}" != "0" ]; then
            echo "xcodebuild failed with exit code ${XCODEBUILD_EXIT}"
            exit "${XCODEBUILD_EXIT}"
          fi
