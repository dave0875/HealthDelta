# Review: Issue #9 — DuckDB Loader from Canonical NDJSON

Reviewed with: `ollama/llama3.1:8b`

Issue: https://github.com/dave0875/HealthDelta/issues/9

## Summary
- Adds `healthdelta duckdb build` to create a local DuckDB database from canonical NDJSON streams produced by Issue #8.
- Adds `healthdelta duckdb query` to execute SQL headlessly and emit deterministic CSV output (given deterministic SQL).
- Schema is explicit and stream-aligned (`observations`, `documents`, optional `medications`, optional `conditions`) with required canonical fields in every table.
- Ingestion uses DuckDB’s newline-delimited JSON reader (no Python full-file loads) and inserts with deterministic `ORDER BY` to promote repeatability.
- CI Linux job installs `duckdb` so tests execute in CI; local environments without duckdb skip the DuckDB test.

## Risks / Gaps
- [severity: medium] `tests/test_duckdb.py` is skipped if `duckdb` is not installed; if CI dependency installation regresses, the test suite could still pass unless CI explicitly verifies `duckdb` import before running tests.
- [severity: medium] Byte-stable `.duckdb` files are not guaranteed across DuckDB versions/platforms; the implementation targets determinism by fixing insert order and using single-threaded execution, but cross-version drift is still possible.
- [severity: low] Query determinism depends on user SQL; without `ORDER BY`, result ordering may vary (documented in runbook).

## Suggested Improvements (Minimal Scope)
- Add a CI pre-check step (Linux job) to print `duckdb.__version__` and fail fast if import fails, ensuring DuckDB tests are not silently skipped.
- Consider pinning `duckdb` to a specific version in CI for repeatability.
- Optionally add a simple `SHOW TABLES` assertion in `tests/test_duckdb.py` to verify optional tables are created when streams exist.

## CI / Artifact Verification
- Verify the `CI` workflow is green for Issue #9 commits:
  - Linux job: installs `duckdb` and runs `tests/test_duckdb.py` (not skipped).
  - macOS self-hosted job: Xcode tests green and `.xcresult` uploaded.
- Spot-check CI logs for:
  - `pip install duckdb` succeeded
  - `tests/test_duckdb.py` executed and validated deterministic DB hash + query outputs.
