# Review â€” Issue 26 (2026-01-22)

Issue: https://github.com/dave0875/HealthDelta/issues/26

Reviewer model
- `ollama/llama3.1:8b` (invoked locally on GORF)

Change summary
- `healthdelta duckdb build` now supports append-safe ingestion by deduping on `record_key` per table.
- DuckDB tables now include `schema_version` and `record_key` columns (keeping `event_key` for compatibility).

Findings
- Correctness: Append-safe behavior is implemented by conditional insert (`WHERE NOT EXISTS ... record_key`), preventing duplicate rows on rerun.
- Determinism: Reruns against identical NDJSON inputs should be idempotent (row counts stable). Deterministic query outputs still require explicit `ORDER BY` in downstream SQL.
- Privacy/PII: Loader continues to project only explicit non-PII columns, ignoring extra fields in NDJSON rows; tests assert synthetic PII tokens do not appear in query outputs.
- Performance/scale: Per-row `NOT EXISTS` checks can be costly at large scale; best-effort unique indexes on `record_key` are created when supported by DuckDB to improve performance.

Risks / edge cases
- Existing DBs created before `record_key` existed will not have the new column; loader errors and requires `--replace` to recreate (documented in error message).
- If index creation fails (DuckDB syntax/version differences), correctness remains (dedupe still occurs), but performance may degrade.

Follow-ups (not in scope)
- Consider set-based ingestion using DuckDB-native JSON scanning plus a unique constraint/`ON CONFLICT DO NOTHING` if/when supported and benchmarked.

