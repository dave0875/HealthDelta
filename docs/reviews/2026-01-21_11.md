# Review: Issue #11 — Incremental Runs + Run Registry

Reviewed with: `ollama/llama3.1:8b`

Issue: https://github.com/dave0875/HealthDelta/issues/11

## Summary
- Adds a durable state directory (default `<base_out>/state`) with deterministic `runs.json` and newline-terminated `LAST_RUN`.
- Implements deterministic `input_fingerprint` (sha256 over relpath + size + sha256(bytes)) and deterministic `run_id` derivation using a pipeline salt + parent linkage.
- Adds no-op behavior when input fingerprint matches parent fingerprint (prints `no changes detected`, returns success, avoids output mutation).
- Adds `healthdelta run register` to register an existing run directory into the registry and update `LAST_RUN` idempotently.
- Adds synthetic-only tests that validate registry determinism, lineage, no-op behavior, and lack of banned-token/path leakage.

## Risks / Gaps
- [severity: medium] Computing fingerprints requires hashing all file bytes; for very large exports this can be expensive (acceptable for this slice, but should be documented as O(total bytes)).
- [severity: medium] The registry uses a wall-clock `created_at`; determinism is achieved via idempotency (do not rewrite existing entries), not by a reproducible timestamp.
- [severity: low] `--since <run_id>` does not currently error if the parent is absent from the registry; it will simply create a new run (acceptable but should be explicit in docs if desired).

## Suggested Improvements (Minimal Scope)
- Consider recording `parent_missing=true` (or similar) in the run registry when `--since` references a non-existent parent to aid debugging.
- Add a small test case for `--since <explicit_run_id>` (not just `last`) to ensure parent selection works as documented.
- Consider adding a cheap “fingerprint summary” (file_count/total_bytes already present) to the “no changes detected” message (still share-safe).

## CI / Artifact Verification
- Verify `CI` is green on Issue #11 commits:
  - Linux job runs the new incremental tests (`tests/test_incremental.py`).
  - macOS self-hosted job runs Xcode tests and uploads `.xcresult` artifact.
- Spot-check CI logs for any accidental printing of input directory paths containing banned tokens (tests intentionally name the input dir `John Doe export` and assert it does not appear in stdout/stderr).
