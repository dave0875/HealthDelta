# Review: Issue #10 — Share-safe Reporting from DuckDB

Reviewed with: `ollama/llama3.1:8b`

Issue: https://github.com/dave0875/HealthDelta/issues/10

## Summary
- Implements `healthdelta report build` to generate deterministic, share-safe artifacts (`summary.json`, `summary.md`, and coverage/timeline CSVs) from the Issue #9 DuckDB schema.
- Implements `healthdelta report show` for a deterministic terminal summary without writing files.
- Ensures determinism via stable ordering, stable formatting, and omission of non-deterministic timestamps (`generated_at`).
- Enforces share-safe outputs by reporting only aggregate metrics and `canonical_person_id`-keyed coverage (no names/DOB/free-text identifiers).
- Adds synthetic-only tests that build a DuckDB fixture via the same NDJSON→DuckDB loader pathway and assert artifact presence, metric correctness, PII token absence, and byte-stability across reruns.

## Risks / Gaps
- [severity: medium] DuckDB-dependent tests are skipped locally when `duckdb` is not installed; CI must remain responsible for executing them (workflow installs DuckDB explicitly).
- [severity: low] Timeline and min/max rely on `event_time` being parseable and non-null; if a dataset has many NULL times, timeline may be sparse (expected and documented).
- [severity: low] “Top record types” are derived from structured type/code fields and are not guaranteed to be semantically complete; this is acceptable for MVP coverage reporting.

## Suggested Improvements (Minimal Scope)
- Add a dedicated assertion in CI logs that DuckDB tests executed (not skipped), e.g., grep for `test_reports`/`test_duckdb` in unittest output.
- Add coverage for the optional `report show` command in tests (stdout contains expected stable keys).
- Add a test case for an input DB missing optional tables (`medications`, `conditions`) to ensure reports still build and CSV headers remain consistent.

## CI / Artifact Verification
- Confirm `CI` workflow is green for Issue #10 commits:
  - Linux job: runs `unittest` and executes DuckDB reporting tests.
  - macOS self-hosted job: `xcodebuild test` green and uploads `.xcresult`.
- Spot-check report artifacts in test logs (or by reproducing locally) to ensure banned synthetic tokens do not appear: `John Doe`, `1980-01-02`, `Patient/p1`.
