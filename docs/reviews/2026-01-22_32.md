# Review â€” Issue 32 (2026-01-22)

Issue: https://github.com/dave0875/HealthDelta/issues/32

Reviewer model
- `ollama/llama3.1:8b` (invoked locally on GORF)

Change summary
- Added `NDJSONWriter` with stable JSON serialization (`.sortedKeys`) and newline termination.
- Added `IncrementalNDJSONExporter` that loads/saves anchors and appends deterministic NDJSON rows derived from anchored query results.
- Added unit tests proving deterministic output across reruns and no-op behavior when unchanged.

Findings
- Correctness: Exporter persists anchors and only appends NDJSON rows when results include changes (samples/deletes).
- Determinism: Rows are sorted by `record_key`; JSON is serialized with sorted keys and newline termination; tests assert byte stability.
- Append-safety: Achieved via persisted anchors; second run with unchanged results does not mutate output bytes.
- Privacy: No logging; tests use synthetic samples.

Risks / edge cases
- Current skeleton normalizes quantity values using `count` for `HKQuantitySample`; future work should support units per type safely and deterministically.
- ISO8601 formatting includes fractional seconds; stable for fixed dates but should be standardized for production scale.

Follow-ups (not in scope)
- Extend schema alignment with canonical NDJSON spec and support additional sample types once incremental export requirements are finalized.

