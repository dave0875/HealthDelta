# HealthDelta Issue #5 Review
=====================================

## Overview
------------

This issue introduces a new command, `healthdelta identity build`, which constructs a canonical person registry and observed alias/provenance records from staged data. The name parsing and matching rule are explicit and testable.

## Correctness of Parsing Rules
-----------------------------

The name parsing rules are implemented in the `_parse_name` function in `identity.py`. These rules are:

*   Trim whitespace
*   Collapse multiple whitespace characters to a single space
*   Case-fold (convert to lowercase)

These rules ensure that names with varying whitespace and case are normalized correctly.

**Acceptance Criteria:**

1.  Names with different whitespace handling (e.g., `"John    Doe"` vs. `" John   Doe"`) result in the same normalized name.
2.  Names with different case handling (e.g., `"JOHN DOE"` vs. `"john doe"`) result in the same normalized name.
3.  Names with multiple tokens separated by whitespace or commas are parsed correctly.

## Provenance / Append-Only Behavior
--------------------------------------

The `aliases.json` file contains observed external IDs and source references, which are appended to each alias record. A stable `alias_key` is generated for each record using a hash of the payload. This ensures that identical observations do not get re-added on subsequent runs.

**Acceptance Criteria:**

1.  The same external ID and source reference do not result in multiple aliases being created.
2.  New observations are appended to the existing `aliases.json` file without overwriting existing records.

## Risks
--------

The main risk associated with this implementation is data loss due to incorrect or missing external IDs. To mitigate this, it is essential to verify that the external ID extraction logic in `_extract_external_ids` function is accurate and complete.

**Acceptance Criteria:**

1.  The `external_ids` list contains all external IDs extracted from each patient resource.
2.  No duplicate external IDs are included in the `aliases.json` file.

## Continuous Integration (CI) Evidence
----------------------------------------

The CI pipeline for this issue can be found at [https://github.com/dave0875/HealthDelta/actions/runs/21172881024](https://github.com/dave0875/HealthDelta/actions/runs/21172881024).

This pipeline includes automated tests for the `identity` command and its components. The test results provide evidence that the code functions as expected.

**Acceptance Criteria:**

1.  All automated tests pass without errors or failures.
2.  The CI pipeline is configured to run on each push to the main branch.

