# Review: Issue #8 — Canonical NDJSON Exporters

Reviewed with: `ollama/qwen2.5:14b-instruct`

Issue: https://github.com/dave0875/HealthDelta/issues/8

## Summary
- Adds `healthdelta export ndjson` and a deterministic NDJSON writer with stable per-line JSON serialization and per-stream sort keys.
- Supports pipeline local (staging) and share (deid) run directories via `layout.json`-based resolution.
- Streams HealthKit `export.xml` and CDA `export_cda.xml` via `xml.etree.ElementTree.iterparse` (no full DOM load).
- Exports minimal, share-safe rows for HealthKit, FHIR (Observation/DocumentReference/MedicationRequest/Condition), and CDA observation-like entries.
- Tests are synthetic-only and exercise local + share modes, determinism, and PII non-inclusion.

## Risks / Gaps
- [severity: medium] Identity-to-record linkage is limited to FHIR `subject.reference == "Patient/<id>"` and identity aliases; if missing/ambiguous, exporter falls back to `"unresolved"` (safe but may reduce usability).
- [severity: medium] CDA extraction is intentionally minimal and only emits `<observation>`-shaped data; many clinically relevant CDA structures will be skipped by design.
- [severity: low] Streaming XML iterparse clears only processed elements; for extremely large inputs this may be improved later by more aggressive clearing patterns.

## Suggested Improvements (Minimal Scope)
- Add a small unit test that validates `--mode share` reads from deid `layout.json` (not just file existence), and that outputs remain PII-free in share mode as well.
- Extend FHIR subject resolution to also recognize `subject.identifier.system/value` when present (still non-PII, improves multi-system linkage).
- Consider a strict “no free-text” policy for exported fields long-term (current implementation already avoids name/DOB output).

## CI / Artifact Verification
- Confirm GitHub Actions `CI` workflow is green for Issue #8 commit(s):
  - Linux job: runs `unittest` and proves deterministic exporter behavior.
  - macOS self-hosted job: `xcodebuild test` green and uploads `.xcresult` bundle.
- Spot-check CI artifacts/logs for any accidental emission of synthetic PII strings used in tests (`John Doe`, `Doe, John`, `1980-01-02`, `19800102`).
