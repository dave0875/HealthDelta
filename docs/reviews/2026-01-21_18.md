# Review: Issue #18 â€” Ingest staging alignment + CDA staging

Reviewed with: `ollama/llama3.1:8b`

Issue: https://github.com/dave0875/HealthDelta/issues/18

## Summary
- Ingest now uses the shared export layout resolver (Issue #17) to avoid broad scans and to handle layout variants deterministically.
- For directory inputs, ingest stages:
  - `export.xml`
  - `export_cda.xml` (when present)
  - clinical JSONs from the resolved clinical tree only, canonicalized under `source/clinical/clinical-records/`
- For zip inputs, ingest also extracts `export_cda.xml` when present and restricts clinical JSON extraction to known clinical trees.
- Tests assert CDA staging, correct counts, and exclusion of unrelated JSON.

## Risks / Gaps
- [severity: low] Canonicalizing clinical file names to `p.name` could collide if two distinct JSON files share the same basename; acceptable for this slice (single-directory clinical-records), but should be revisited if nested clinical trees are encountered.

## Determinism + privacy checks
- Eliminates broad staging of arbitrary JSON, reducing performance risk and preventing accidental inclusion of non-clinical files.
- Layout/manifest remain share-safe and deterministic; CDA staging path is stable.

## CI / artifacts checklist
- Confirm CI green:
  - Linux tests job
  - macOS Xcode job with `ios-xcresult` artifact
- Post Actions run URL on Issue #18 and close the issue after verification.

