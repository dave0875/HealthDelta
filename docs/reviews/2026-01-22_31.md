# Review â€” Issue 31 (2026-01-22)

Issue: https://github.com/dave0875/HealthDelta/issues/31

Reviewer model
- `ollama/llama3.1:8b` (invoked locally on GORF)

Change summary
- Added protocol abstraction `AnchoredQuerying` and result type `AnchoredQueryResult`.
- Implemented `HealthKitAnchoredQueryClient` using `HKAnchoredObjectQuery` bridged into async/await.
- Implemented `FakeAnchoredQueryClient` for deterministic tests.
- Added unit tests validating anchor progression and no-op behavior.

Findings
- Correctness: Live client returns added/deleted samples and the new anchor from HealthKit; fake client is deterministic and script-driven.
- Determinism: Tests assert deterministic anchor behavior by comparing archived anchor bytes (avoids relying on Equatable conformance).
- Robustness: Live client throws on missing anchors; fake has a deterministic fallback when the script is exhausted.
- Privacy: No logs and tests use synthetic sample values only.

Risks / edge cases
- Async bridging must ensure the continuation is resumed exactly once; `HKAnchoredObjectQuery` results handler is expected to fire once per query execution.
- Future work should consider cancellation and timeout behavior for long-running queries.

Follow-ups (not in scope)
- Integrate with `AnchorStore` for persistence and build incremental export logic (Issue #32).

