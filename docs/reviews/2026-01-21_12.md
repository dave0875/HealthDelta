# Review: Issue #12 — Operator Command (`healthdelta run all`)

Reviewed with: `ollama/llama3.1:8b`

Issue: https://github.com/dave0875/HealthDelta/issues/12

## Summary
- Adds a single operator command (`healthdelta run all`) that runs ingest → identity → deid (share) → NDJSON → DuckDB → reports under a run-scoped output tree.
- Defaults to share-safe behavior (`--mode share`) and avoids logging raw input paths.
- Adds deterministic no-op behavior when input fingerprint matches the latest registered run (no new run, no output mutation).
- Adds end-to-end synthetic tests proving artifact creation, no-op determinism, and banned-token absence.

## Risks / Gaps
- [severity: medium] Fingerprinting reads and hashes all file bytes (O(total bytes)); large exports may be slow (acceptable for this slice).
- [severity: medium] `created_at` is wall-clock; determinism relies on idempotent registry writes (no rewrite when no-op).
- [severity: low] Local environments without `duckdb` will skip the operator integration test; CI must remain the authoritative proof.

## Suggested Improvements (Minimal Scope)
- Add a small test for the case where `--since <run_id>` references a missing run in the registry (error vs. proceed should be explicit).
- Consider not creating an empty `<run_id>/deid/` directory in `--mode local` to reduce confusion (purely cosmetic).

## Determinism + Privacy Checklist
- No-op path avoids mutation:
  - `runs.json` and `LAST_RUN` stay byte-identical on unchanged input (covered in `tests/test_operator.py`).
  - report artifacts (`summary.json`, `summary.md`) stay byte-identical on unchanged input (covered in `tests/test_operator.py`).
- Share-safe default path:
  - share mode exports NDJSON from de-identified inputs (operator uses `<run_id>/deid` as NDJSON input).
- No PII in outputs:
  - test asserts banned synthetic tokens (“John Doe”, “1980-01-02”, etc.) do not appear in NDJSON, reports, or registry.
  - artifact pointers stored in the registry are relative (no absolute input paths).

## CI / Artifacts Checklist
- Confirm CI green for the Issue #12 commit:
  - Linux job runs `tests/test_operator.py` (requires `duckdb` present in CI environment).
  - macOS self-hosted job runs Xcode tests and uploads `.xcresult` artifact.
- Post the Actions run URL and artifact confirmation on Issue #12 before closing.

